/* Define folders and output file */
%let folder1 = C:\Users\rooneyz\Documents\Code\SAS_Out\DAC_CSV;
%let folder2 = C:\Users\rooneyz\Documents\TestData\raw_data_csv\Enyo_v2_CSV;
%let output_file = C:\Users\rooneyz\Documents\Code\SAS_Out\comparison_results.xlsx;

/* Step 1: Create an empty dataset to store comparison results */
data comparison_results;
    length filename $100. variable $32. base_value $200. compare_value $200.;
    stop;
run;

/* Step 2: Get list of CSV files */
filename csvlist pipe "dir /b &folder1.\*.csv";
data csv_files;
    length filename $100.;
    infile csvlist truncover;
    input filename $;
run;

/* Step 3: Macro to compare CSV files */
%macro compare_csvs(file);
    /* Import both files */
    proc import datafile="&folder1.\&file" out=work.f1_data dbms=csv replace;
        guessingrows=max;
    run;

    proc import datafile="&folder2.\&file" out=work.f2_data dbms=csv replace;
        guessingrows=max;
    run;

    /* Compare the datasets */
    proc compare base=work.f1_data compare=work.f2_data
                 out=work.diffs outnoequal noprint;
    run;

    /* Check if differences exist */
    %if %sysfunc(exist(work.diffs)) %then %do;
        /* Add filename to differences */
        data work.diffs;
            set work.diffs;
            length filename $100.;
            filename = "&file";
        run;

        /* Append to results */
        proc append base=comparison_results data=work.diffs force;
        run;
    %end;

    /* Clean up temporary datasets */
    proc datasets library=work nolist;
        delete f1_data f2_data diffs;
    quit;
%mend;

/* Step 4: Loop through all CSV files */
data _null_;
    set csv_files;
    call execute('%compare_csvs(' || trim(filename) || ')');
run;

/* Step 5: Export results if any differences found */
%macro export_results;
    %let dsid = %sysfunc(open(comparison_results));
    %let nobs = %sysfunc(attrn(&dsid, nobs));
    %let rc = %sysfunc(close(&dsid));

    %if &nobs > 0 %then %do;
        proc export data=comparison_results
            outfile="&output_file"
            dbms=xlsx
            replace;
        run;

        %put NOTE: Comparison results exported to &output_file;
        %put NOTE: &nobs differences found;
    %end;
    %else %do;
        %put NOTE: No differences found between the datasets;
    %end;
%mend;

%export_results;
