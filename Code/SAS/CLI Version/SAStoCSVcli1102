/* Parse command line arguments using -sysparm */
%let args = %sysfunc(getoption(sysparm));

/* Extract arguments (expecting format: lib_path,out_dir,replace_opt) */
%let lib_path = %scan(&args, 1, %str(,));
%let out_dir = %scan(&args, 2, %str(,));
%let replace_opt = %scan(&args, 3, %str(,));

/* Set defaults if not provided */
%if &lib_path = %then %let lib_path = C:\data;
%if &out_dir = %then %let out_dir = C:\exports;
%if &replace_opt = %then %let replace_opt = YES;

%macro export_lib_from_path(libpath=, outdir=, replace=YES);
  /* Check if input directory exists */
  %if %sysfunc(fileexist(&libpath)) = 0 %then %do;
    %put ERROR: Input directory &libpath does not exist;
    %return;
  %end;

  /* Create temporary library reference */
  libname TEMPLIB "&libpath";

  /* Check if library was created successfully */
  %if %sysfunc(libref(TEMPLIB)) ne 0 %then %do;
    %put ERROR: Cannot create library reference for &libpath;
    %return;
  %end;

  /* Get list of datasets */
  proc sql noprint;
    select memname
      into :dsns separated by '|'
    from dictionary.tables
    where libname="TEMPLIB" and memtype='DATA';
  quit;

  %if %length(&dsns)=0 %then %do;
    %put NOTE: No datasets found in directory &libpath;
    libname TEMPLIB clear;
    %return;
  %end;

  /* Create output directory if it doesn't exist */
  %if %sysfunc(fileexist(&outdir)) = 0 %then %do;
    %put NOTE: Creating directory &outdir;
    options noxwait noxsync;
    %sysexec mkdir "&outdir";
  %end;

  /* Export each dataset to CSV */
  %let i = 1;
  %do %while(%scan(&dsns, &i, '|') ne );
    %let ds = %scan(&dsns, &i, '|');
    %let outfile = &outdir\&ds..csv;

    %if %upcase(&replace)=YES %then %let _rep=replace; %else %let _rep=;

    %put NOTE: Exporting &ds to &outfile;

    proc export data=TEMPLIB.&ds
                outfile="&outfile"
                dbms=csv
                &_rep;
    run;

    %let i = %eval(&i + 1);
  %end;

  /* Clear temporary library reference */
  libname TEMPLIB clear;
%mend export_lib_from_path;

/* Execute with command line parameters */
%export_lib_from_path(libpath=&lib_path, outdir=&out_dir, replace=&replace_opt);


/* Execute with command line parameters */
%export_lib(lib=&lib_name, outdir=&out_dir, replace=&replace_opt);


