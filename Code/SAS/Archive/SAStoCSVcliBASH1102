#!/bin/bash

# Check if input directory is provided
if [ $# -eq 0 ]; then
    echo "Usage: $0 <library_name> [output_directory] [replace_option]"
    echo "Example: $0 MYLIB ./output/DAC_CSV YES"
    exit 1
fi

LIB_NAME=${1}
OUT_DIR=${2:-"./output/DAC_CSV"}
REPLACE=${3:-"YES"}

# Create temporary SAS script
cat > /tmp/export_lib_temp.sas << 'EOF'
%macro export_lib(lib=WORK, outdir=./output/DAC_CSV, replace=YES);
  %let libup = %upcase(&lib);

  proc sql noprint;
    select memname
      into :dsns separated by '|'
    from dictionary.tables
    where libname="&libup" and memtype='DATA';
  quit;

  %if %length(&dsns)=0 %then %do;
    %put NOTE: No datasets found in library &lib;
    %return;
  %end;

  %if %sysfunc(fileexist(&outdir)) = 0 %then %do;
    %put NOTE: Creating directory &outdir;
    options noxwait noxsync;
    %sysexec mkdir -p "&outdir";
  %end;

  %let i = 1;
  %do %while(%scan(&dsns, &i, '|') ne );
    %let ds = %scan(&dsns, &i, '|');
    %let outfile = &outdir/&ds..csv;

    %if %upcase(&replace)=YES %then %let _rep=replace; %else %let _rep=;

    proc export data=&lib..&ds
                outfile="&outfile"
                dbms=csv
                &_rep;
    run;

    %let i = %eval(&i + 1);
  %end;
%mend export_lib;

%export_lib(lib=LIB_PLACEHOLDER, outdir=DIR_PLACEHOLDER, replace=REPLACE_PLACEHOLDER);
EOF

# Replace placeholders with actual values
sed -i "s|LIB_PLACEHOLDER|${LIB_NAME}|g" /tmp/export_lib_temp.sas
sed -i "s|DIR_PLACEHOLDER|${OUT_DIR}|g" /tmp/export_lib_temp.sas
sed -i "s|REPLACE_PLACEHOLDER|${REPLACE}|g" /tmp/export_lib_temp.sas

# Run SAS script
sas -sysin /tmp/export_lib_temp.sas

# Clean up
rm /tmp/export_lib_temp.sas


#chmod +x run_sas_export.sh
#./run_sas_export.sh MYLIB ./output/DAC_CSV YES
