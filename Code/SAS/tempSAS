sas
/********************************************************************************
*
* PROGRAM: compare_folders.sas
* PURPOSE: Compares two folders of CSV files and writes a single Excel report.
*
********************************************************************************/

* --- 1. SET MACRO VARIABLES (ACTIVE) --- ;
%let folder_a_path = C:\my_projects\folder_a;
%let folder_b_path = C:\my_projects\folder_b;
%let output_excel_file = C:\my_projects\reports\comparison_report.xlsx;

%macro compare_csv_dirs(dir1=, dir2=, out=, pattern=*.csv);
  %local ncommon i file ndiffs outpath rc;

  /* use provided out or default to work folder */
  %if %length(&out)=0 %then %let out=%sysfunc(pathname(work))\comparison_report.xlsx;
  %let outpath=&out;

  /* get file lists from Windows directories */
  filename f1 pipe "dir /b /a-d ""&dir1.\&pattern.""";
  data work.files1;
    length fname $256;
    infile f1 lrecl=256 truncover;
    input fname $char256.;
    fname = lowcase(strip(fname));
  run;
  filename f1 clear;

  filename f2 pipe "dir /b /a-d ""&dir2.\&pattern.""";
  data work.files2;
    length fname $256;
    infile f2 lrecl=256 truncover;
    input fname $char256.;
    fname = lowcase(strip(fname));
  run;
  filename f2 clear;

  /* determine common and unique files */
  proc sql noprint;
    create table work.common_files as
      select a.fname
      from work.files1 a
      inner join work.files2 b
        on a.fname = b.fname
      order by a.fname;

    create table work.files_only_a as
      select fname from work.files1
      where fname not in (select fname from work.files2);

    create table work.files_only_b as
      select fname from work.files2
      where fname not in (select fname from work.files1);

    select count(*) into :ncommon trimmed from work.common_files;
  quit;

  /* initialize summary table */
  data work.comparison_summary;
    length filename $256 comparison_result $50 n_diffs 8;
    stop;
  run;

  /* append unique files to summary */
  data work.append_only_a;
    set work.files_only_a;
    length comparison_result $50;
    filename = fname;
    comparison_result = "Only in Folder A";
    n_diffs = .;
    keep filename comparison_result n_diffs;
  run;
  proc append base=work.comparison_summary data=work.append_only_a force; run;

  data work.append_only_b;
    set work.files_only_b;
    length comparison_result $50;
    filename = fname;
    comparison_result = "Only in Folder B";
    n_diffs = .;
    keep filename comparison_result n_diffs;
  run;
  proc append base=work.comparison_summary data=work.append_only_b force; run;

  /* loop over common files */
  %if %eval(&ncommon > 0) %then %do;
    proc sql noprint;
      select fname into :file1-:file%sysfunc(strip(&ncommon)) trimmed
      from work.common_files;
    quit;

    %do i=1 %to &ncommon;
      %let file=&&file&i;

      /* import CSVs */
      proc import datafile="&dir1.\&file" out=work._left dbms=csv replace;
        getnames=yes; guessingrows=32767;
      run;

      proc import datafile="&dir2.\&file" out=work._right dbms=csv replace;
        getnames=yes; guessingrows=32767;
      run;

      /* compare and output differences dataset */
      proc compare base=work._left compare=work._right out=work._diffs outnoequal noprint;
      run;

      /* count differences */
      %let ndiffs=0;
      %if %sysfunc(exist(work._diffs)) %then %do;
        proc sql noprint;
          select count(*) into :ndiffs trimmed from work._diffs;
        quit;
        %if &ndiffs= %then %let ndiffs=0;
      %end;

      /* append per-file result */
      data work.temp_result;
        length filename $256 comparison_result $50 n_diffs 8;
        filename = "&file";
        n_diffs = &ndiffs;
        if n_diffs > 0 then comparison_result = "Data differs";
        else comparison_result = "Identical";
        keep filename comparison_result n_diffs;
      run;
      proc append base=work.comparison_summary data=work.temp_result force; run;

      /* cleanup per-file helpers */
      proc datasets lib=work nolist;
        delete _left _right _diffs temp_result;
      quit;
    %end;
  %end;

  /* export final summary to Excel */
  proc export data=work.comparison_summary
    outfile="&outpath"
    dbms=xlsx
    replace;
    sheet="ComparisonSummary";
  run;

  /* cleanup helper tables */
  proc datasets lib=work nolist;
    delete files1 files2 common_files files_only_a files_only_b
           append_only_a append_only_b;
  quit;
%mend compare_csv_dirs;

/* Run comparison using the active Step 1 variables */
%compare_csv_dirs(dir1=&folder_a_path, dir2=&folder_b_path, out=&output_excel_file);
